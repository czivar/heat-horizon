<a href="#" onClick="javascript:save_template();">Save Template</a>
    <label>Template Name</label>
    <input type="text" name="name">
    <label>Template Description</label>
    <input type="text" name="description">
<a href='{% url horizon:thermal:designer:resource %}'  id="resource__edit_resource" class="btn btn-small ajax-modal btn-create">Add Resource</a>
<a href='{% url horizon:thermal:designer:parameter %}'  id="parameter__edit_parameter" class="btn btn-small ajax-modal btn-create">Add Parameter</a>
<div id="designer" class="row-fluid" style="position:relative;height:100em;">
  <div id="parameters" class="parameter" style="top:0em;">
    Parameters:
  </div> 
</div>
<script type="text/javascript">
  var r_ct = 0;
  var p_ct = 0;

  var exampleColor = "#00f";
  var dropOptions = {
        tolerance:'touch',
        hoverClass:'dropHover',
        activeClass:'dragActive'
      };
  var connectorStyle = {
        //connector: "StateMachine",
        gradient:{stops:[[0, exampleColor], [0.5, "#09098e"], [1, exampleColor]]},
        lineWidth:3,
        strokeStyle:exampleColor,
        //dashstyle:"2 2"
      };
  var paintStyle = { width:25, height:21, fillStyle:exampleColor };
  var resourceEndpoint = {
      //endpoint:"Rectangle",
      paintStyle: paintStyle,
      isSource:true,
      reattach:true,
      //scope:"blue rectangle",
      connectorStyle: connectorStyle,
      //beforeDrop:function(params) { 
      //    return confirm("Connect " + params.sourceId + " to " + params.targetId + "?"); 
      //},              
      dropOptions: dropOptions,
      maxConnections: -1
  };
  var parameterEndpoint = {
      //endpoint:"Rectangle",
      paintStyle: paintStyle,
      reattach:true,
      //scope:"blue rectangle",
      connectorStyle: connectorStyle,
      isTarget:true,
      //beforeDrop:function(params) { 
      //    return confirm("Connect " + params.sourceId + " to " + params.targetId + "?"); 
      //},              
      dropOptions: dropOptions,
      maxConnections: -1
  };

  var anchors = [[1, 0.2, 1, 0], [0.8, 1, 0, 1], [0, 0.8, -1, 0], [0.2, 0, 0, -1] ],
      maxConnectionsCallback = function(info) {
         alert("Cannot drop connection " + info.connection.id + " : maxConnections has been reached on Endpoint " + info.endpoint.id);
      };

  horizon.addInitFunction(function() {
    $(document).on('hidden', '.modal', function (evt) {
      modal_response = $("#modal_response");
      if(modal_response.length){
        // if we have a modal_response parse it
        try {
          json_data = $.parseJSON(modal_response.text());
          if(json_data['type'] == 'parameter') {
            add_parameter(json_data['name'], json_data['Default']);
          } else if(json_data['type'] == 'resource') {
            add_resource(json_data['name']);
          } else { 
            alert('Unhandled response type:' + json_data['type']);
          };
        } catch(err) { alert(err); };
        // remove it after we're done
        modal_response.remove();
      };
    });
  });

  jsPlumb.ready(function() {
    jsPlumb.bind("click", function(c) { 
       jsPlumb.detach(c); 
    });
  });

  function add_resource(name) {
    //var r = 'resource'.concat(r_ct++); 
    var d = $('<div>'.concat(name).concat('</div>'));
    d.attr('id', name);
    d.attr('class', 'resource window');
    d.css('left', String(3*r_ct++).concat('em'));
    d.css('top', String(3*r_ct++).concat('em'));
    d.appendTo('#designer');
    jsPlumb.addEndpoint(d, { anchor:anchors }, resourceEndpoint);
    jsPlumb.draggable(d, { containment:"parent" });
  };

  function add_parameter(name, def) {
    p_ct++;
    //var p = 'parameter'.concat(p_ct++); 
    var d_str = '<div>'.concat(name);
        d_str = d_str.concat('<p>');
        d_str = d_str.concat('<default>');
        d_str = d_str.concat(def);
        d_str = d_str.concat('</default>');
        d_str = d_str.concat('</p>');
        d_str = d_str.concat('</div>');
    var d = $(d_str);
    d.attr('id', name);
    d.attr('class', 'parameter');
    d.css('top', String(3*p_ct).concat('em'));
    d.appendTo('#designer');
    jsPlumb.addEndpoint(d, { anchor:[0, 0.5, -1, 0, -10, -2] }, parameterEndpoint); //{
        //isTarget:true,
        //reattach:true,
        //dropOptions: exampleDropOptions, });
  };

  function save_template() {
    //alert($('input[name=csrfmiddlewaretoken]').attr('value'));
    $.post('{% url horizon:thermal:designer:index %}',
            { template: $('#designer').html(),
              csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').attr('value'),
              name: $('input[name=name]').val(),
              description: $('input[name=name]').val() } );
  };

  function blah() {
    jsPlumb.connect({ source:"container0", target:"container1" });
  };

</script>
